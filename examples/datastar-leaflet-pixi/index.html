<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datastar + Leaflet.PixiOverlay</title>
    
    <!-- Datastar JS -->
    <script type="module" src="https://cdn.jsdelivr.net/gh/starfederation/datastar@v1.0.0-beta.11/bundles/datastar.js"></script>
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- PIXI.js -->
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.3.2/dist/pixi.min.js"></script>
    
    <!-- Leaflet.PixiOverlay -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-pixi-overlay@1.9.4/L.PixiOverlay.min.js"></script>
    
    <!-- Our map component -->
    <script type="module" src="/static/js/leaflet-pixi-component.js"></script>
    
    <!-- Basic Styling -->
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <style>
        #map { 
            height: 100%; 
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 300px;
        }
        .loading-dots { opacity:0; transition: opacity 200ms ease-out; }
        .loading-dots.loading { opacity:1; transition: opacity 200ms ease-in; }
        .loading-dots::after { content: ' .'; animation: loading-dots 1s steps(5, end) infinite; }
        @keyframes loading-dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);} 40% { color: inherit; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);} 60% { text-shadow: .25em 0 0, .5em 0 0 rgba(0,0,0,0);} 80%, 100% { text-shadow: .25em 0 0, .5em 0 0;} }
    </style>
</head>
<body>
    <!-- Map container -->
    <div id="map"></div>
    
    <!-- Main container: Initialize ALL signals -->
    <div data-signals="{
        polygons: [],
        userSelection: null,
        center: {lat: 37.7749, lng: -122.4194},
        zoom: 13,
        processing: false
    }" class="control-panel">
        <h1 class="text-lg font-bold mb-4">Map Controls</h1>
        
        <div class="loading-dots text-blue-600 mb-4" data-class="{'loading': $processing}">Processing</div>
        
        <!-- Zoom Controls -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Zoom Level</label>
            <div class="flex items-center gap-2">
                <input type="range" min="3" max="18" step="1" 
                       data-bind-zoom
                       data-on-input="mapComponent.setZoom($zoom)"
                       class="w-full">
                <span class="text-sm font-mono w-8 text-right" data-text="$zoom"></span>
            </div>
        </div>
        
        <!-- Selection Distance Control -->
        <div class="mb-4" data-if="$userSelection">
            <label class="block text-sm font-medium text-gray-700 mb-1">Selection Radius (m)</label>
            <div class="flex items-center gap-2">
                <input type="range" min="50" max="2000" step="50" 
                       data-value="200"
                       data-on-input="$userSelection && @get('/update-selection', {center: $userSelection.center, distance: parseInt(this.value)})"
                       data-indicator-processing
                       class="w-full">
                <span class="text-sm font-mono w-16 text-right" data-text="$userSelection ? $userSelection.distance : ''"></span>
            </div>
        </div>
        
        <!-- Polygon Creation -->
        <div class="mb-4" data-if="$userSelection">
            <button
                class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors"
                data-on-click="@get('/create-polygon', {
                    polygonID: 'poly_' + Date.now(),
                    timestamp: Date.now(),
                    color: '#' + Math.floor(Math.random()*16777215).toString(16),
                    fillColor: '#' + Math.floor(Math.random()*16777215).toString(16) + '55'
                })"
                data-indicator-processing
            >
                Create Polygon from Selection
            </button>
        </div>
        
        <!-- Current selection info -->
        <div class="mb-4 text-sm" data-if="$userSelection">
            <h3 class="font-semibold">Current Selection:</h3>
            <p>Center: <span data-text="$userSelection ? `${$userSelection.center.lat.toFixed(4)}, ${$userSelection.center.lng.toFixed(4)}` : ''"></span></p>
            <p>Radius: <span data-text="$userSelection ? `${$userSelection.distance} meters` : ''"></span></p>
        </div>
        
        <!-- Polygon Count -->
        <div class="text-sm text-gray-600">
            <p>Polygons: <span data-text="$polygons.length"></span></p>
        </div>
        
        <!-- Instructions -->
        <div class="mt-4 text-xs text-gray-500">
            <p>Click on the map to create a selection point, then adjust the radius and create a polygon.</p>
        </div>
    </div>
    
    <!-- Leaflet Pixi Map Component -->
    <leaflet-pixi-map
        data-attr-center="$center"
        data-attr-zoom="$zoom"
        data-attr-polygons="$polygons"
        data-attr-user-selection="$userSelection"
        data-on-selection-change="$userSelection = evt.detail; @get('/update-selection', {center: evt.detail.center, distance: evt.detail.distance})"
        data-indicator-processing
    ></leaflet-pixi-map>

    <script>
        // Store reference to the map component for direct control
        let mapComponent;
        document.addEventListener('DOMContentLoaded', () => {
            mapComponent = document.querySelector('leaflet-pixi-map');
            
            // Connect to SSE endpoint for updates
            fetch('/map-stream');
        });
    </script>
</body>
</html>